<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=false">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="style.css">
    <title>Querimonia - Melden</title>
</head>
<body>
    <script>
        var create_email = false;
        var final_transcript = '';
        var recognizing = false;
        var ignore_onend;
        var start_timestamp;
        function showInfo (text) {
            console.log(text);
        }
        function startVoiceInput() {
            if (recognizing) {
                recognition.stop();
                return;
            }
            final_transcript = '';
            recognition.lang = 'de-DE';
            recognition.start();
            ignore_onend = false;
            start_timestamp = event.timeStamp;
        }
        function initVoiceInput() {
            console.log('startVoiceInput');
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.onstart = function () {
                recognizing = true;
                showInfo('info_speak_now');
            };
            recognition.onerror = function (event) {
                if (event.error == 'no-speech') {
                    showInfo('info_no_speech');
                    ignore_onend = true;
                }
                if (event.error == 'audio-capture') {
                    showInfo('info_no_microphone');
                    ignore_onend = true;
                }
                if (event.error == 'not-allowed') {
                    if (event.timeStamp - start_timestamp < 100) {
                        showInfo('info_blocked');
                    } else {
                        showInfo('info_denied');
                    }
                    ignore_onend = true;
                }
            };
            recognition.onend = function () {
                recognizing = false;
                if (ignore_onend) {
                    return;
                }
                if (!final_transcript) {
                    showInfo('info_start');
                    return;
                }
                showInfo('');
            };
            recognition.onresult = function (event) {
                var interim_transcript = '';
                for (var i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        final_transcript += event.results[i][0].transcript;
                    } else {
                        interim_transcript += event.results[i][0].transcript;
                    }
                }
                final_transcript = final_transcript;
                // final_span.innerHTML = linebreak(final_transcript);
                // interim_span.innerHTML = linebreak(interim_transcript);
                console.log('final_transcript', final_transcript);
                console.log('interim_transcript', interim_transcript);
            };
        }
        initVoiceInput();
    </script>
    <div>
        <input type='button' onclick="startVoiceInput()" />
    </div>
</body>
</html>